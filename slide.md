# AWSに触ってみる

IoT事業本部第1開発部4課 徳武

---

## この研修の目的

- サーバーインフラをふんわり理解する
- PaaSやSaaSのありがたみを理解する

---

## AWSって？

- AWS(Amazon Web Services)はAmazonの提供するWebサービスのこと
- IaaS(Infrastructure as a Service)やPaaS(Platform as a Service)、SaaS(Software as a Service)を提供している

>>>

## IaaS？PaaS？SaaS？

- IaaS: Amazon EC2など。ユーザーがサーバーの細かい設定を気にしないといけない
- PaaS: Amazon RDS, Herokuなど。ユーザーは使う上でサーバーの細かい設定を気にしなくて済む
- SaaS: Amazon Rekognition, Gmailなど。ユーザーは使う上でサーバーのリソースとか気にしないで済む

>>>

## IaaSが出現する以前は...

- 自社にサーバーを用意したり
- データセンターのラックを借りたり
- VPSを利用したり

<img src="./image/datacenter-286386_1280.jpg" alt="ラックサーバー" width="320px">

>>>

## IaaSが出現して以降は...

- ボタンポチポチで簡単にサーバーが立てられる！
    - コンピューターリソースの進化
    - コンピューターの仮想化技術の発達

<img src="./image/dance_yorokobi_mai_man.png" alt="喜びの舞" width="320px">

>>>

## いろいろなクラウドベンダー

- AWS
- Microsoft Azure
- GCP(Google Cloud Platform)

---

## 実際に触ってみよう

1. Amazon EC2を触る
2. Amazon RDSを触る
3. クリーンアップ作業
    - 上記作業中に作成したコンポーネントやサービスをメモしておこう
    - (あとで滞りなくクリーンアップするためです)

---

## Amazon EC2

- 仮想サーバーを提供するサービス
- とりあえずログインして、サービス一覧からEC2を選べ！
    1. 事前に渡したIAM情報にログインURLがあるのでブラウザで開いてログイン
    2. 右上の「バージニア北部」をクリックして「アジアパシフィック (東京)」を選択
    3. 左上の「サービス」をクリックして検索フォームに「ec2」と入力してenter

>>>

## EC2の仮想サーバーを立ち上げる part1

1. 左メニューの「インスタンス」をクリック
2. 「インスタンスの作成」という青いボタンをクリック
3. 「Amazon Linux 2」を選択して「選択」ボタンをクリック
4. タイプが「t2.micro」となっている行を選択していることを確認
5. 「次の手順:インスタンスの詳細の設定」ボタンをクリック

>>>

## EC2の仮想サーバーを立ち上げる part2

6. 「次の手順:ストレージの追加」ボタンをクリック
7. 「次の手順:タグの追加」ボタンをクリック
8. タグの設定
    - キー: Name
    - 値: (自分のものだとわかりやすい名前)
9. 「次の手順:セキュリティグループの設定」ボタンをクリック

>>>

## EC2の仮想サーバーを立ち上げる part3

10. セキュリティグループ(SG)の設定 part1
    1. 「セキュリティグループ名」に自分のものだとわかりやすい名前を入力
    2. [確認くん](https://www.ugtop.com/spill.shtml)などを使って自分のグローバルIPを確認
    3. タイプ「SSH」のソースを「(グローバルIP)/32」に変更

>>>

## EC2の仮想サーバーを立ち上げる part4

10. セキュリティグループ(SG)の設定 part2
    4. 「ルールの追加」ボタンをクリック
    5. 追加したルールのタイプを「HTTP」に変更
    6. 追加したルールのソースを「(グローバルIP)/32」に変更

>>>

## EC2の仮想サーバーを立ち上げる part5

11. 「確認と作成」ボタンをクリック
12. 「作成」ボタンをクリック
13. キーペアの作成
    1. 「新しいキーペアの作成」を選択
    2. キーペア名に自分のものだとわかりやすい名前を入れて「キーペアのダウンロード」をクリック
    3. 「インスタンスの作成」ボタンをクリック

>>>

## EC2インスタンスにNginxをインストール

1. インスタンス一覧で自分の作成したインスタンスの「IPv4パブリックIP」を確認
2. ターミナルで以下を実施
    ```
    $ chmod 600 ~/Downloads/(キーペア名).pem
    $ ssh ec2-user@(IPv4パブリックIP) -i ~/Downloads/(キーペア名).pem # サーバーにssh
    > sudo yum update
    > amazon-linux-extras                        # nginxのバージョンを確認
    > sudo amazon-linux-extras install nginx1.12 # nginxのインストール
    > sudo systemctl enable nginx
    > sudo systemctl start nginx
    ```
3. ブラウザで`http://(IPv1パブリックIP)`を開く

>>>

## 現状のインフラ構成図

TODO: 図を貼る

>>>

## 現状の構成の問題点

- 冗長性がない: 一台故障したらサービスが停止してしまう
- (他にも色々あるがここでは無視)

>>>

## Load Balancerを導入する Part1

1. 左メニューの「ロードバランサー」をクリック
2. 「ロードバランサーを作成」という青いボタンをクリック
3. 「Application Load Balancer」の「作成」ボタンをクリック
4. 名前に自分のものとわかりやすい名前を入力
5. アベイラビリティーゾーン全てにチェック

>>>

## Load Balancerを導入する Part2

6. タグの設定
    - キー: Name
    - 値: (自分のものだとわかりやすい名前)
7. 「次の手順:セキュリティ設定の構成」ボタンをクリック
8. 「次の手順:セキュリティグループの設定」ボタンをクリック

>>>

## Load Balancerを導入する Part3

9. SGの設定
    1. 「新しいセキュリティグループを作成する」にチェック
    2. セキュリティグループ名に自分のものだとわかりやすい名前を入れる
    3. タイプ「HTTP」のソースを「(グローバルIP)/32」に変更
    4. 「次の手順:ルーティングの設定」ボタンをクリック

>>>

## Load Balancerを導入する Part4

10. ターゲットグループの設定
    1. 名前に自分のものだとわかりやすい名前を入力
    2. ヘルスチェックの詳細設定をクリック
    3. 正常のしきい値を5 => 2に変更
    4. 間隔を30 => 10に変更
    5. 「次の手順:ターゲットの登録」ボタンをクリック

>>>

## Load Balancerを導入する Part5

11. ターゲットの登録
    1. 自分のインスタンスにチェック
    2. 「登録済みに追加」ボタンをクリック
    3. 「次の手順:確認」をクリック
12. 「作成」ボタンをクリック

>>>

## Load Balancerを導入する Part6

13. インスタンス用SGの変更
    1. 左メニューの「セキュリティグループ」をクリック
    2. 自分のインスタンスで使っているセキュリティグループを選択
    3. 「インバウンド」タブの「編集」ボタンをクリック
    4. 「ソース」に自分のALB(Application Load Balancer)用SGのグループIDを入力

>>>

## Load Balancerを導入する Part7

14. 正常に動作しているか確認
    1. 左メニューの「ターゲットグループ」をクリック
    2. 自分の作成したターゲットグループを選択
    3. 「ターゲット」をクリックして、インスタンスのステータスがhealtyになっているか確認

>>>

## Load Balancerを導入する Part8

15. ページの表示を確認
    1. 左メニューの「ロードバランサー」をクリック
    2. 自分の作成したロードバランサーを選択
    3. 「DNS名」をそのままコピーして、ブラウザで開く

>>>

## インスタンスを1台追加する

- TODO: AMIの準備
- TODO: もう一台EC2インスタンスを準備する

>>>

## Auto Scaling Groupを導入する

- TODO: Auto Scaling Groupと起動設定の準備手順を書く
- TODO: Auto Scalingに紐づいていないインスタンスは削除する

>>>

## 現状のインフラ構成図

TODO: 図を貼る

---

## Amazon RDS

- マネージドなRDB(Relational DataBase)を提供するサービス
- サービス一覧からRDSを選べ！

>>>

## PostgreSQLをインストール

- Homebrew, GCC, asdfがインストールされていることを確認
    - `brew --version`
    - `gcc --version`
    - `asdf --version`
- PostgreSQLのインストール
    - `asdf plugin-add postgres`
    - `asdf install postgres 9.6.6 && asdf global postgres 9.6.6`
    - (エラーが起こらないことを祈る)

>>>

## RDBって？

>>>

## RDSの何が嬉しいの？

>>>

## RDSインスタンスを立ち上げる

- TODO: RDS起動までの手順を書いてく
- TODO: 注意点も書いておく
    - VPC内アクセス限定にしろ
    - セキュリティーグループ使え

>>>

## CLI Clientから操作

- TODO: テーブル作成
- TODO: レコード挿入
- TODO: スナップショット作成
- TODO: テーブル削除
- TODO: スナップショットから復元

---

## クリーンアップ作業

- TBD
